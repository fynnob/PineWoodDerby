<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Hub â€” Pinewood Derby</title>
  <link rel="stylesheet" href="../styles.css" />
</head>
<body>

<nav class="top-nav">
  <span class="brand">ğŸï¸ Derby</span>
  <a href="index.html" class="active">Hub</a>
  <a href="inspection.html">Inspection</a>
  <a href="track.html">Track</a>
  <a href="results.html">Results</a>
  <a href="rounds.html">Rounds</a>
</nav>

<div class="container">
  <div class="page-header" style="margin-top:24px;">
    <div class="title-block">
      <h1>Race Control</h1>
      <p>Select a station below to open it on this device.</p>
    </div>
  </div>

  <!-- Status strip -->
  <div class="card" id="statusCard">
    <div class="card-title">Event Status</div>
    <div id="statusBody" style="display:flex; gap:24px; flex-wrap:wrap; align-items:center;">
      <span class="spinner"></span>
    </div>
  </div>

  <!-- Station cards -->
  <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:16px;">

    <a href="inspection.html" style="text-decoration:none;">
      <div class="card" style="cursor:pointer; text-align:center; transition: border-color .2s;"
           onmouseover="this.style.borderColor='var(--accent2)'"
           onmouseout="this.style.borderColor='var(--border)'">
        <div style="font-size:3rem; margin-bottom:8px;">ğŸ”</div>
        <h3>Inspection</h3>
        <p style="font-size:0.85rem; margin-top:4px;">Scan QR, approve / reject cars</p>
      </div>
    </a>

    <a href="track.html" style="text-decoration:none;">
      <div class="card" style="cursor:pointer; text-align:center; transition: border-color .2s;"
           onmouseover="this.style.borderColor='var(--accent2)'"
           onmouseout="this.style.borderColor='var(--border)'">
        <div style="font-size:3rem; margin-bottom:8px;">ğŸ›¤ï¸</div>
        <h3>Track Setup</h3>
        <p style="font-size:0.85rem; margin-top:4px;">See current lane assignments, advance heat</p>
      </div>
    </a>

    <a href="results.html" style="text-decoration:none;">
      <div class="card" style="cursor:pointer; text-align:center; transition: border-color .2s;"
           onmouseover="this.style.borderColor='var(--accent2)'"
           onmouseout="this.style.borderColor='var(--border)'">
        <div style="font-size:3rem; margin-bottom:8px;">ğŸ</div>
        <h3>Results Entry</h3>
        <p style="font-size:0.85rem; margin-top:4px;">Enter 1stâ€“4th place finish order</p>
      </div>
    </a>

    <a href="rounds.html" style="text-decoration:none;">
      <div class="card" style="cursor:pointer; text-align:center; transition: border-color .2s;"
           onmouseover="this.style.borderColor='var(--accent2)'"
           onmouseout="this.style.borderColor='var(--border)'">
        <div style="font-size:3rem; margin-bottom:8px;">âš™ï¸</div>
        <h3>Round Control</h3>
        <p style="font-size:0.85rem; margin-top:4px;">Start rounds, eliminate cars, manage event</p>
      </div>
    </a>

  </div>

  <!-- Quick car list -->
  <div class="card" style="margin-top:24px;">
    <div class="card-title">All Registered Cars (<span id="carCount">0</span>)</div>
    <div id="allCars"><span class="spinner"></span></div>
  </div>

</div>

<script src="../config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script>
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  async function loadStatus() {
    const [{ data: state }, { data: cars }] = await Promise.all([
      sb.from('race_state').select('*,rounds(*),heats(*)').eq('id', 1).single(),
      sb.from('cars').select('id, car_number, kid_name, legal_status, eliminated').order('car_number')
    ]);

    // Status strip
    const round = state?.rounds;
    const heat  = state?.heats;
    document.getElementById('statusBody').innerHTML = `
      <div>
        <div style="font-size:0.75rem;color:var(--muted);text-transform:uppercase;">Round</div>
        <div style="font-size:1.5rem;font-weight:800;color:var(--accent)">
          ${round ? '#' + round.round_number : 'â€”'}
        </div>
      </div>
      <div>
        <div style="font-size:0.75rem;color:var(--muted);text-transform:uppercase;">Heat</div>
        <div style="font-size:1.5rem;font-weight:800;color:var(--accent2)">
          ${heat ? '#' + heat.heat_number : 'â€”'}
        </div>
      </div>
      <div>
        <div style="font-size:0.75rem;color:var(--muted);text-transform:uppercase;">Registered</div>
        <div style="font-size:1.5rem;font-weight:800;">${cars?.length ?? 0}</div>
      </div>
      <div>
        <div style="font-size:0.75rem;color:var(--muted);text-transform:uppercase;">Legal</div>
        <div style="font-size:1.5rem;font-weight:800;color:var(--success)">
          ${cars?.filter(c => c.legal_status === 'legal').length ?? 0}
        </div>
      </div>
    `;

    // Car list
    document.getElementById('carCount').textContent = cars?.length ?? 0;
    if (!cars?.length) {
      document.getElementById('allCars').innerHTML =
        '<div class="empty-state">No cars registered yet.</div>';
      return;
    }

    document.getElementById('allCars').innerHTML = cars.map(car => `
      <div class="car-list-item">
        <div class="info">
          <div class="num">#${car.car_number}</div>
          <div class="name">${car.kid_name}</div>
        </div>
        <span class="badge badge-${car.legal_status}">
          ${car.legal_status === 'legal' ? 'âœ… Legal' :
            car.legal_status === 'not_legal' ? 'âŒ Not Legal' : 'â³ Pending'}
        </span>
        ${car.eliminated ? '<span class="badge badge-pending">Eliminated</span>' : ''}
      </div>
    `).join('');
  }

  loadStatus();
</script>
</body>
</html>
