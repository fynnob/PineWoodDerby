<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Derby Registration</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

<!-- Sticky header -->
<div style="background:#fff; border-bottom:1px solid var(--border); padding:16px; box-shadow:var(--shadow); position:sticky; top:0; z-index:99;">
  <div style="max-width:640px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; gap:12px;">
    <div style="display:flex; align-items:center; gap:10px;">
      <div>
        <h1 style="font-size:1.2rem;">Pinewood Derby</h1>
        <p style="font-size:0.75rem; margin:0;">Car Registration</p>
      </div>
    </div>
    <button class="btn btn-primary btn-sm" id="showQrBtn" onclick="showDeviceQR()" style="display:none;">
      ğŸ“± My QR
    </button>
  </div>
</div>

<div class="container" style="padding-top:20px;">

  <!-- Registration form -->
  <div class="card">
    <div class="card-title">Register a Car</div>

    <label for="kidName">Racer's Name</label>
    <input type="text" id="kidName" placeholder="e.g. Alex Johnson" maxlength="80"
           autocomplete="off" autocapitalize="words" />

    <label for="carImage">Car Photo <span style="color:var(--accent); font-weight:600;">(recommended)</span></label>
    <input type="file" id="carImage" accept="image/*" capture="environment" />
    <p style="font-size:0.78rem; color:var(--muted2); margin-top:-8px; margin-bottom:12px;">Tapping this opens your camera so you can take a new photo right now â€” no file browsing needed.</p>

    <div id="imagePreviewWrap" style="display:none; margin-bottom:14px;">
      <img id="imagePreview" src="" alt="preview"
           style="max-height:160px; border-radius:10px; border:1px solid var(--border); display:block;" />
    </div>

    <button class="btn btn-gold btn-lg btn-full" id="registerBtn">
      â• Register Car
    </button>
  </div>

  <!-- Registered cars for this device -->
  <div class="card">
    <div class="card-title">Your Registered Cars</div>
    <div id="carList">
      <div class="empty-state">No cars registered from this device yet.</div>
    </div>
  </div>

</div>

<!-- Edit car modal -->
<div class="modal-overlay" id="editModal" onclick="closeEditModal(event)">
  <div class="modal-sheet">
    <div style="font-size:0.75rem; font-weight:700; color:var(--muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:12px;">Edit Car</div>
    <label for="editKidName">Racer's Name</label>
    <input type="text" id="editKidName" placeholder="Racer's name" maxlength="80" autocapitalize="words" />
    <label for="editCarImage" style="margin-top:12px;">Replace Photo <span style="color:var(--muted2); font-weight:400;">(optional)</span></label>
    <input type="file" id="editCarImage" accept="image/*" capture="environment" />
    <p style="font-size:0.78rem; color:var(--muted2); margin-top:-8px; margin-bottom:12px;">Opens camera â€” leave empty to keep existing photo.</p>
    <div id="editPreviewWrap" style="display:none; margin-bottom:14px;">
      <img id="editPreview" src="" alt="preview" style="max-height:120px; border-radius:10px; border:1px solid var(--border); display:block;" />
    </div>
    <button class="btn btn-gold btn-full" id="editSaveBtn" onclick="saveCarEdit()">Save Changes</button>
    <button class="btn btn-ghost btn-full" style="margin-top:8px;" onclick="closeEditModal()">Cancel</button>
  </div>
</div>

<!-- Delete car confirm -->
<div class="confirm-overlay" id="delCarOverlay" style="display:none;">
  <div class="confirm-box">
    <p style="margin-bottom:20px; font-weight:600;">Delete this car? This cannot be undone.</p>
    <div style="display:flex; gap:12px;">
      <button class="btn btn-ghost btn-full" onclick="closeDelModal()">Cancel</button>
      <button class="btn btn-full" style="background:#dc2626; color:#fff;" onclick="confirmCarDelete()">Delete</button>
    </div>
  </div>
</div>

<!-- Full-screen QR modal (bottom sheet on mobile) -->
<div class="modal-overlay" id="qrModal" onclick="closeQR(event)">
  <div class="modal-sheet">
    <div style="font-size:0.75rem; font-weight:700; color:var(--muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:12px;">Your Check-in QR</div>
    <div style="display:flex; justify-content:center; margin-bottom:16px;">
      <div class="qr-block" id="qrCanvas"></div>
    </div>
    <p style="font-size:0.85rem; margin-bottom:12px;">
      Show this at inspection â€” it covers all your cars.
    </p>
    <p style="font-size:1.2rem; font-weight:900; letter-spacing:6px; color:var(--accent); margin-bottom:20px;" id="qrShortCode"></p>
    <button class="btn btn-ghost btn-full" onclick="closeQR()">Close</button>
  </div>
</div>

<div id="toast"></div>

<!-- Dependencies -->
<script src="config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
  const sb        = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const STORE_KEY  = 'derby_my_cars';
  const TOKEN_KEY  = 'derby_device_token';

  // â”€â”€ Device token (one per browser / device) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // All cars registered here share this token so inspection can
  // scan ONE QR and see the whole family's cars at once.
  function getDeviceToken() {
    let t = localStorage.getItem(TOKEN_KEY);
    if (!t) {
      t = crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(36) + Math.random().toString(36).slice(2);
      localStorage.setItem(TOKEN_KEY, t);
    }
    return t;
  }

  // â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function toast(msg, ok = true) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.className = ok ? 'show ok' : 'show err';
    clearTimeout(el._t);
    el._t = setTimeout(() => el.className = '', 3000);
  }

  // â”€â”€ localStorage helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function getMyCars() { return JSON.parse(localStorage.getItem(STORE_KEY) || '[]'); }
  function saveMyCar(car) {
    const list = getMyCars(); list.push(car);
    localStorage.setItem(STORE_KEY, JSON.stringify(list));
  }

  // â”€â”€ Image preview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('carImage').addEventListener('change', function () {
    const file = this.files[0]; if (!file) return;
    document.getElementById('imagePreview').src = URL.createObjectURL(file);
    document.getElementById('imagePreviewWrap').style.display = 'block';
  });

  // â”€â”€ Register â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('registerBtn').addEventListener('click', async () => {
    const kidName    = document.getElementById('kidName').value.trim();
    const fileEl     = document.getElementById('carImage');
    const file       = fileEl.files[0];
    const deviceToken = getDeviceToken();

    if (!kidName) { toast('Enter the racer\'s name first.', false); return; }

    const btn = document.getElementById('registerBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Registeringâ€¦';

    try {
      let imageUrl = null;

      if (file) {
        const ext      = file.name.split('.').pop();
        const fileName = `car_${Date.now()}.${ext}`;
        const { error: upErr } = await sb.storage
          .from('car-images')
          .upload(fileName, file, { contentType: file.type, upsert: false });
        if (upErr) throw upErr;
        imageUrl = sb.storage.from('car-images').getPublicUrl(fileName).data.publicUrl;
      }

      // car_number is auto-assigned by DB trigger; device_token links all family cars
      const { data: car, error: carErr } = await sb
        .from('cars')
        .insert({ kid_name: kidName, image_url: imageUrl, device_token: deviceToken })
        .select()
        .single();

      if (carErr) throw carErr;

      saveMyCar(car);
      renderCarList();
      renderDeviceQR();

      document.getElementById('kidName').value = '';
      fileEl.value = '';
      document.getElementById('imagePreviewWrap').style.display = 'none';

      toast(`Car #${car.car_number} registered! ğŸ`);
    } catch (err) {
      console.error(err);
      toast('Registration failed â€” ' + err.message, false);
    } finally {
      btn.disabled = false;
      btn.innerHTML = 'â• Register Car';
    }
  });

  // â”€â”€ Device QR (covers all cars from this device) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderDeviceQR() {
    const list = getMyCars();
    if (!list.length) return;
    document.getElementById('showQrBtn').style.display = 'inline-flex';
  }

  function showDeviceQR() {
    const token = getDeviceToken();
    const shortCode = tokenToShortCode(token);
    const canvas = document.getElementById('qrCanvas');
    canvas.innerHTML = '';
    new QRCode(canvas, {
      text:         token,
      width:        256, height: 256,
      colorDark:    '#000', colorLight: '#fff',
      correctLevel: QRCode.CorrectLevel.H
    });
    document.getElementById('qrShortCode').textContent = shortCode;
    document.getElementById('qrModal').classList.add('open');
  }

  // Derive a stable 4-char letters-only code from the device token
  function tokenToShortCode(token) {
    let hash = 0;
    for (let i = 0; i < token.length; i++) {
      hash = ((hash << 5) - hash) + token.charCodeAt(i);
      hash |= 0;
    }
    hash = Math.abs(hash);
    const letters = 'ABCDEFGHJKLMNPQRSTUVWXYZ'; // no I or O to avoid confusion
    let code = '';
    for (let i = 0; i < 4; i++) {
      code += letters[hash % letters.length];
      hash = Math.floor(hash / letters.length);
    }
    return code;
  }

  function closeQR(e) {
    if (!e || e.target.id === 'qrModal' || e.target.tagName === 'BUTTON') {
      document.getElementById('qrModal').classList.remove('open');
    }
  }

  // â”€â”€ Car list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function statusLabel(s) {
    return s === 'legal' ? 'âœ… Legal' : s === 'not_legal' ? 'âŒ Not Legal' : 'â³ Pending';
  }

  function renderCarList() {
    const list = getMyCars();
    const el   = document.getElementById('carList');

    if (!list.length) {
      el.innerHTML = '<div class="empty-state">No cars registered from this device yet.</div>';
      return;
    }

    el.innerHTML = list.map(car => `
      <div class="car-list-item">
        <img src="${car.image_url || ''}"
             onerror="this.style.display='none'"
             alt="${car.kid_name}" />
        <div class="info">
          <div class="num">#${car.car_number}</div>
          <div class="name">${car.kid_name}</div>
          <div style="margin-top:4px;">
            <span class="badge badge-${car.legal_status}" id="badge_${car.id}">${statusLabel(car.legal_status)}</span>
          </div>
          <div style="display:flex; gap:8px; margin-top:10px;">
            <button class="btn btn-sm" style="background:var(--accent2); color:#fff;" onclick="openCarEdit('${car.id}')">Edit</button>
            <button class="btn btn-sm" style="background:#dc2626; color:#fff;" onclick="openDelModal('${car.id}')">Delete</button>
          </div>
        </div>
      </div>
    `).join('');

    refreshStatuses(list.map(c => c.id));
  }

  async function refreshStatuses(ids) {
    const { data } = await sb.from('cars').select('id,legal_status').in('id', ids);
    if (!data) return;
    const map = {};
    data.forEach(r => map[r.id] = r.legal_status);
    const list = getMyCars().map(c => ({ ...c, legal_status: map[c.id] || c.legal_status }));
    localStorage.setItem(STORE_KEY, JSON.stringify(list));
    list.forEach(car => {
      const b = document.getElementById('badge_' + car.id);
      if (b) { b.className = `badge badge-${car.legal_status}`; b.textContent = statusLabel(car.legal_status); }
    });
  }

  // â”€â”€ Edit car â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let _editCarId = null;

  function openCarEdit(carId) {
    _editCarId = carId;
    const car = getMyCars().find(c => c.id === carId);
    if (!car) return;
    document.getElementById('editKidName').value = car.kid_name;
    document.getElementById('editCarImage').value = '';
    document.getElementById('editPreviewWrap').style.display = 'none';
    document.getElementById('editModal').classList.add('open');
  }

  document.getElementById('editCarImage').addEventListener('change', function () {
    const file = this.files[0]; if (!file) return;
    document.getElementById('editPreview').src = URL.createObjectURL(file);
    document.getElementById('editPreviewWrap').style.display = 'block';
  });

  function closeEditModal(e) {
    if (!e || e.target.id === 'editModal' || e.target.tagName === 'BUTTON') {
      document.getElementById('editModal').classList.remove('open');
    }
  }

  async function saveCarEdit() {
    const newName = document.getElementById('editKidName').value.trim();
    if (!newName) { toast('Name cannot be empty.', false); return; }

    const btn = document.getElementById('editSaveBtn');
    btn.disabled = true; btn.textContent = 'Savingâ€¦';

    try {
      const fileEl = document.getElementById('editCarImage');
      const file   = fileEl.files[0];
      let patch = { kid_name: newName };

      if (file) {
        const ext      = file.name.split('.').pop();
        const fileName = `car_${Date.now()}.${ext}`;
        const { error: upErr } = await sb.storage.from('car-images')
          .upload(fileName, file, { contentType: file.type, upsert: false });
        if (upErr) throw upErr;
        patch.image_url = sb.storage.from('car-images').getPublicUrl(fileName).data.publicUrl;
      }

      const { error } = await sb.from('cars').update(patch).eq('id', _editCarId);
      if (error) throw error;

      const list = getMyCars().map(c => c.id === _editCarId ? { ...c, ...patch } : c);
      localStorage.setItem(STORE_KEY, JSON.stringify(list));
      renderCarList();
      document.getElementById('editModal').classList.remove('open');
      toast('Car updated!');
    } catch (err) {
      toast('Update failed â€” ' + err.message, false);
    } finally {
      btn.disabled = false; btn.textContent = 'Save Changes';
    }
  }

  // â”€â”€ Delete car â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let _deleteCarId = null;

  function openDelModal(carId) {
    _deleteCarId = carId;
    document.getElementById('delCarOverlay').style.display = 'flex';
  }

  function closeDelModal() {
    document.getElementById('delCarOverlay').style.display = 'none';
    _deleteCarId = null;
  }

  async function confirmCarDelete() {
    if (!_deleteCarId) return;
    const btn = document.querySelector('#delCarOverlay button[onclick="confirmCarDelete()"]');
    if (btn) { btn.disabled = true; btn.textContent = 'Deletingâ€¦'; }
    try {
      const { error } = await sb.from('cars').delete().eq('id', _deleteCarId);
      if (error) throw error;
      const list = getMyCars().filter(c => c.id !== _deleteCarId);
      localStorage.setItem(STORE_KEY, JSON.stringify(list));
      renderCarList();
      renderDeviceQR();
      document.getElementById('delCarOverlay').style.display = 'none';
      _deleteCarId = null;
      toast('Car deleted.');
    } catch (err) {
      toast('Delete failed â€” ' + err.message, false);
      if (btn) { btn.disabled = false; btn.textContent = 'Delete'; }
    }
  }

  // â”€â”€ Realtime: push legal_status changes to this device's badges â”€
  sb.channel('parent-cars')
    .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'cars' }, payload => {
      const car = payload.new;
      const badge = document.getElementById('badge_' + car.id);
      if (!badge) return;
      badge.className   = `badge badge-${car.legal_status}`;
      badge.textContent = statusLabel(car.legal_status);
      // keep localStorage in sync
      const list = getMyCars().map(c => c.id === car.id ? { ...c, legal_status: car.legal_status } : c);
      localStorage.setItem(STORE_KEY, JSON.stringify(list));
    })
    .subscribe();

  // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  getDeviceToken(); // ensure token exists early
  renderCarList();
  renderDeviceQR();
</script>
</body>
</html>
