<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Race Display â€” Pinewood Derby</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:       #0b0d14;
      --surface:  #131620;
      --card:     #1a1e2e;
      --border:   #252a3d;
      --amber:    #f59e0b;
      --amber-dim:#7a4e06;
      --text:     #e8eaf2;
      --muted:    #6b738f;
      --gold:     #ffd700;
      --silver:   #b8bec8;
      --bronze:   #cd7f32;
      --green:    #22c55e;
    }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
      display: grid;
      grid-template-rows: auto 1fr;
    }

    /* â”€â”€ Header â”€â”€ */
    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0 40px;
      height: 72px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 24px;
    }

    .hdr-brand {
      display: flex;
      flex-direction: column;
    }
    .hdr-brand .title {
      font-size: 1.4rem;
      font-weight: 900;
      letter-spacing: 4px;
      text-transform: uppercase;
      color: var(--amber);
      line-height: 1;
    }
    .hdr-brand .subtitle {
      font-size: 0.65rem;
      font-weight: 600;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: var(--muted);
      margin-top: 3px;
    }

    .hdr-heat {
      text-align: center;
      flex: 1;
    }
    .hdr-heat .heat-main {
      font-size: 1.1rem;
      font-weight: 800;
      letter-spacing: 1px;
      color: var(--text);
    }

    .hdr-live {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.7rem;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--green);
    }
    .live-dot {
      width: 8px; height: 8px;
      background: var(--green);
      border-radius: 50%;
      animation: blink 2s ease-in-out infinite;
    }
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50%       { opacity: 0.2; }
    }

    /* â”€â”€ Body â”€â”€ */
    .display-body {
      display: grid;
      grid-template-columns: 55% 45%;
      overflow: hidden;
    }

    /* â”€â”€ Panel shared â”€â”€ */
    .panel {
      padding: 28px 36px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .panel-left { border-right: 1px solid var(--border); }

    .panel-label {
      font-size: 0.65rem;
      font-weight: 800;
      letter-spacing: 4px;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 18px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 12px;
    }

    /* â”€â”€ Lane rows â”€â”€ */
    .lane-rows { display: flex; flex-direction: column; gap: 12px; flex: 1; }

    .lane-row {
      display: flex;
      align-items: center;
      gap: 0;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      flex: 1;
    }

    .lane-stripe {
      width: 6px;
      align-self: stretch;
      background: var(--amber);
      flex-shrink: 0;
    }
    .lane-stripe.s1 { background: var(--gold); }
    .lane-stripe.s2 { background: var(--silver); }
    .lane-stripe.s3 { background: var(--bronze); }
    .lane-stripe.s4 { background: #4f8ef7; }

    .lane-inner {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 16px 24px;
      flex: 1;
    }

    .ln-badge {
      font-size: 0.7rem;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--muted);
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 4px 10px;
      white-space: nowrap;
    }

    .ln-num {
      font-size: 3.2rem;
      font-weight: 900;
      color: var(--amber);
      line-height: 1;
      min-width: 72px;
      text-align: center;
    }

    .ln-name {
      font-size: 1.7rem;
      font-weight: 700;
      color: var(--text);
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* â”€â”€ Leaderboard rows â”€â”€ */
    .board-rows { display: flex; flex-direction: column; gap: 10px; flex: 1; }

    .board-row {
      display: flex;
      align-items: center;
      gap: 16px;
      background: var(--card);
      border: 1px solid var(--border);
      border-left: 4px solid var(--border);
      border-radius: 10px;
      padding: 14px 20px;
      flex: 1;
    }
    .board-row.pos-1 { border-left-color: var(--gold);   }
    .board-row.pos-2 { border-left-color: var(--silver); }
    .board-row.pos-3 { border-left-color: var(--bronze); }

    .bd-rank {
      font-size: 0.7rem;
      font-weight: 800;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--muted);
      min-width: 32px;
      text-align: center;
    }
    .board-row.pos-1 .bd-rank { color: var(--gold); font-size: 1.3rem; }
    .board-row.pos-2 .bd-rank { color: var(--silver); font-size: 1.3rem; }
    .board-row.pos-3 .bd-rank { color: var(--bronze); font-size: 1.3rem; }

    .bd-carnum {
      font-size: 1.5rem;
      font-weight: 900;
      color: var(--amber);
      min-width: 54px;
      text-align: center;
    }

    .bd-name {
      flex: 1;
      font-size: 1.15rem;
      font-weight: 700;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .bd-pts {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--muted);
      white-space: nowrap;
    }

    /* â”€â”€ Empty / waiting states â”€â”€ */
    .idle-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
      gap: 14px;
      color: var(--muted);
    }
    .idle-state .idle-icon {
      font-size: 4rem;
      opacity: 0.4;
    }
    .idle-state p {
      font-size: 1.1rem;
      font-weight: 600;
      letter-spacing: 1px;
    }

    @media (max-width: 900px) {
      .display-body { grid-template-columns: 1fr; overflow: auto; }
      body { overflow: auto; }
      .ln-num  { font-size: 2.2rem !important; }
      .ln-name { font-size: 1.2rem !important; }
    }
  </style>
</head>
<body>

<header>
  <div class="hdr-brand">
    <div class="title">Pinewood Derby</div>
    <div class="subtitle">Cub Scouts Race Day</div>
  </div>

  <div class="hdr-heat">
    <div class="heat-main" id="heatInfoText">Loadingâ€¦</div>
  </div>

  <div class="hdr-live">
    <div class="live-dot"></div>
    Live
  </div>
</header>

<div class="display-body">

  <!-- Left: current lanes -->
  <div class="panel panel-left">
    <div class="panel-label">Now on Track</div>
    <div class="lane-rows" id="laneRows">
      <div class="idle-state">
        <div class="idle-icon">â³</div>
        <p>Waiting to start</p>
      </div>
    </div>
  </div>

  <!-- Right: leaderboard -->
  <div class="panel">
    <div class="panel-label">Standings</div>
    <div class="board-rows" id="boardRows">
      <div class="idle-state">
        <div class="idle-icon">ğŸ†</div>
        <p>No results yet</p>
      </div>
    </div>
  </div>

</div>

<script src="../config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script>
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // â”€â”€ Refresh data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function refresh() {
    const { data: state } = await sb
      .from('race_state')
      .select('current_round_id, current_heat_id, heats(heat_number, rounds(round_number))')
      .eq('id', 1)
      .single();

    updateHeatInfo(state);
    await Promise.all([
      updateLanes(state?.current_heat_id ?? null),
      updateLeaderboard(state?.current_round_id ?? null)
    ]);
  }

  function updateHeatInfo(state) {
    const heat  = state?.heats;
    const round = heat?.rounds;
    const el    = document.getElementById('heatInfoText');
    if (heat && round) {
      el.textContent = `Round ${round.round_number} â€” Heat ${heat.heat_number}`;
    } else {
      el.textContent = 'No active heat';
    }
  }

  // â”€â”€ Lanes panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function updateLanes(heatId) {
    const el = document.getElementById('laneRows');

    if (!heatId) {
      el.innerHTML = `
        <div class="idle-state">
          <div class="idle-icon">â³</div>
          <p>Waiting to start</p>
        </div>`;
      return;
    }

    const { data: entries } = await sb
      .from('heat_entries')
      .select('lane_number, cars(car_number, kid_name)')
      .eq('heat_id', heatId)
      .order('lane_number');

    if (!entries?.length) {
      el.innerHTML = `<div class="idle-state"><p>No lane data</p></div>`;
      return;
    }

    const stripes = ['s1','s2','s3','s4'];
    el.innerHTML = entries.map((e, i) => `
      <div class="lane-row">
        <div class="lane-stripe ${stripes[i] || ''}"></div>
        <div class="lane-inner">
          <div class="ln-badge">Lane ${e.lane_number}</div>
          <div class="ln-num">${e.cars?.car_number ?? 'â€”'}</div>
          <div class="ln-name">${e.cars?.kid_name ?? 'â€”'}</div>
        </div>
      </div>
    `).join('');
  }

  // â”€â”€ Leaderboard panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function updateLeaderboard(roundId) {
    const el = document.getElementById('boardRows');

    if (!roundId) {
      el.innerHTML = `
        <div class="idle-state">
          <div class="idle-icon">ğŸ†</div>
          <p>No results yet</p>
        </div>`;
      return;
    }

    // Fetch results for current round
    const { data: results } = await sb
      .from('heat_results')
      .select(`
        first_place_car, second_place_car, third_place_car, fourth_place_car,
        heats!inner(round_id)
      `)
      .eq('heats.round_id', roundId);

    const { data: activeCars } = await sb
      .from('cars')
      .select('id, car_number, kid_name')
      .eq('eliminated', false);

    if (!activeCars?.length) {
      el.innerHTML = `<div class="idle-state"><p>No active cars</p></div>`;
      return;
    }

    // Tally points
    const pts = {};
    activeCars.forEach(c => pts[c.id] = 0);
    (results || []).forEach(r => {
      if (pts[r.first_place_car]  !== undefined) pts[r.first_place_car]  += 1;
      if (pts[r.second_place_car] !== undefined) pts[r.second_place_car] += 2;
      if (pts[r.third_place_car]  !== undefined) pts[r.third_place_car]  += 3;
      if (pts[r.fourth_place_car] !== undefined) pts[r.fourth_place_car] += 4;
    });

    const sorted = activeCars
      .map(c => ({ ...c, points: pts[c.id] ?? 0 }))
      .filter(c => c.points > 0)  // only show cars that have raced
      .sort((a, b) => a.points - b.points || a.car_number - b.car_number)
      .slice(0, 6);

    if (!sorted.length) {
      el.innerHTML = `
        <div class="idle-state">
          <div class="idle-icon">ğŸ†</div>
          <p>No results yet</p>
        </div>`;
      return;
    }

    const rankLabel = ['1st', '2nd', '3rd', '4th', '5th', '6th'];
    el.innerHTML = sorted.map((car, i) => `
      <div class="board-row pos-${i + 1}">
        <div class="bd-rank">${rankLabel[i] ?? i + 1}</div>
        <div class="bd-carnum">#${car.car_number}</div>
        <div class="bd-name">${car.kid_name}</div>
        <div class="bd-pts">${car.points} pts</div>
      </div>
    `).join('');
  }

  // â”€â”€ Live subscription (Supabase Realtime) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  sb.channel('display-channel')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'race_state' },   refresh)
    .on('postgres_changes', { event: '*', schema: 'public', table: 'heat_results' }, refresh)
    .on('postgres_changes', { event: '*', schema: 'public', table: 'heat_entries' }, refresh)
    .subscribe();

  // â”€â”€ Init + poll fallback every 8 s â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  refresh();
  setInterval(refresh, 8000);
</script>
</body>
</html>
