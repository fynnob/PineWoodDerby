<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Announcer â€” Pinewood Derby</title>
  <link rel="stylesheet" href="../styles.css" />
</head>
<body>

<!-- PIN gate -->
<div id="pinGate" style="position:fixed;inset:0;z-index:9999;background:var(--bg);display:flex;align-items:center;justify-content:center;">
  <div style="text-align:center;max-width:300px;padding:20px;">
    <h2 style="margin-bottom:8px;">Admin Access</h2>
    <p style="margin-bottom:16px;">Enter the 4-digit PIN</p>
    <input type="tel" id="pinInput" maxlength="4" placeholder="â€¢â€¢â€¢â€¢" autocomplete="off"
           style="text-align:center;font-size:2rem;letter-spacing:12px;width:160px;margin:0 auto 16px;display:block;" />
    <p id="pinErr" style="color:var(--danger);font-size:0.82rem;min-height:1.4em;"></p>
  </div>
</div>
<script>
(function(){
  const PIN='2468',KEY='derby_admin_pin';
  if(localStorage.getItem(KEY)===PIN){document.getElementById('pinGate').style.display='none';}
  else{document.getElementById('pinInput').addEventListener('input',function(){if(this.value.length===4){if(this.value===PIN){localStorage.setItem(KEY,PIN);document.getElementById('pinGate').style.display='none';}else{document.getElementById('pinErr').textContent='Wrong PIN';this.value='';}}});document.getElementById('pinInput').focus();}
})();
</script>

<nav class="top-nav">
  <span class="brand">Derby</span>
  <a href="index.html">Hub</a>
  <a href="inspection.html">Inspection</a>
  <a href="track.html">Track</a>
  <a href="results.html">Officials</a>
  <a href="cars.html">Cars</a>
  <a href="announcer.html" class="active">Screen</a>
</nav>

<div class="container">

  <!-- â”€â”€ Screen URL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="card">
    <div class="card-title">Display Screen URL</div>
    <p style="font-size:0.85rem; color:var(--muted2); margin-bottom:12px;">
      Open this URL on the TV/projector, then control it from here.
    </p>
    <div id="screenUrlText" style="font-size:0.9rem; font-weight:700; color:var(--accent2); word-break:break-all; margin-bottom:14px;"></div>
    <div id="screenQR" style="display:inline-block;"></div>
  </div>

  <!-- â”€â”€ Quick Slides â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="card">
    <div class="card-title">Quick Slides</div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
      <button class="btn btn-gold btn-lg" onclick="pushSlide({type:'register'})">ğŸ“± Registration QR</button>
      <button class="btn btn-primary btn-lg" onclick="pushSlide({type:'race'})">ğŸ Race View</button>
      <button class="btn btn-ghost btn-lg" style="grid-column:span 2;" onclick="pushSlide({type:'idle'})">â¬› Clear Screen</button>
    </div>
  </div>

  <!-- â”€â”€ Text Announcement â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="card">
    <div class="card-title">Text Announcement</div>
    <textarea id="announceText" rows="3"
              placeholder="e.g. Please clear the track â€” racing in 2 minutes!"
              style="width:100%; margin-bottom:10px;"></textarea>
    <button class="btn btn-primary btn-full" onclick="pushText()">Show on Screen</button>
  </div>

  <!-- â”€â”€ Upload + Push Image â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="card">
    <div class="card-title">Push Image</div>
    <p style="font-size:0.82rem; color:var(--muted2); margin-bottom:12px;">
      Upload an image (sponsor logo, schedule, etc.) to show fullscreen on the display.
      Images are stored in the <strong>announcements</strong> Supabase bucket â€” create it as
      a public bucket if you haven't already.
    </p>
    <input type="file" id="imgFile" accept="image/*" onchange="previewUploadImg(this)" style="margin-bottom:10px;" />
    <div id="uploadPreviewWrap" style="display:none; margin-bottom:10px;">
      <img id="uploadPreview" src="" alt="preview"
           style="max-width:100%; max-height:200px; border-radius:10px; border:1px solid var(--border); object-fit:contain;" />
    </div>
    <p id="uploadErr" style="color:var(--danger); font-size:0.82rem; min-height:1.2em;"></p>
    <button class="btn btn-gold btn-full" id="uploadImgBtn" onclick="uploadAndPush()">Upload &amp; Show</button>
  </div>

  <!-- â”€â”€ Recent Images â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="card">
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
      <div class="card-title" style="margin:0;">Saved Images</div>
      <button class="btn btn-ghost btn-sm" onclick="loadImages()">â†» Refresh</button>
    </div>
    <p style="font-size:0.82rem; color:var(--muted2); margin-bottom:12px;">Tap any image to push it to the screen.</p>
    <div id="imageGrid" style="display:grid; grid-template-columns:repeat(auto-fill,minmax(110px,1fr)); gap:8px;">
      <span class="spinner"></span>
    </div>
  </div>

</div>

<div id="toast"></div>

<script src="../config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  function toast(msg, ok = true) {
    const el = document.getElementById('toast');
    el.textContent = msg; el.className = ok ? 'show ok' : 'show err';
    setTimeout(() => el.className = '', 3000);
  }

  // â”€â”€ Screen URL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const screenUrl = location.href.replace('admin/announcer.html', 'display/screen.html');
  document.getElementById('screenUrlText').textContent = screenUrl;
  new QRCode(document.getElementById('screenQR'), {
    text: screenUrl, width: 160, height: 160,
    colorDark: '#000', colorLight: '#fff',
    correctLevel: QRCode.CorrectLevel.H
  });

  // registration URL (parent page)
  const regUrl = location.href.replace('admin/announcer.html', 'index.html');

  // â”€â”€ Broadcast helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const ch = sb.channel('announcer-control');
  ch.subscribe();

  async function pushSlide(payload) {
    // Registration QR needs the reg URL
    if (payload.type === 'register') payload.url = regUrl;
    await ch.send({ type: 'broadcast', event: 'slide', payload });
    toast('Sent to screen!');
  }

  function pushText() {
    const msg = document.getElementById('announceText').value.trim();
    if (!msg) { toast('Enter some text first.', false); return; }
    pushSlide({ type: 'text', message: msg });
  }

  // â”€â”€ Image upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function previewUploadImg(input) {
    const file = input.files?.[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      document.getElementById('uploadPreview').src = e.target.result;
      document.getElementById('uploadPreviewWrap').style.display = 'block';
    };
    reader.readAsDataURL(file);
  }

  async function uploadAndPush() {
    const fileInput = document.getElementById('imgFile');
    const file = fileInput.files?.[0];
    if (!file) { toast('Choose an image first.', false); return; }

    const btn = document.getElementById('uploadImgBtn');
    btn.disabled = true; btn.textContent = 'Uploadingâ€¦';
    document.getElementById('uploadErr').textContent = '';

    try {
      const ext      = file.name.split('.').pop() || 'jpg';
      const fileName = `img_${Date.now()}.${ext}`;
      const { error: upErr } = await sb.storage
        .from('announcements')
        .upload(fileName, file, { contentType: file.type, upsert: false });
      if (upErr) throw upErr;

      const url = sb.storage.from('announcements').getPublicUrl(fileName).data.publicUrl;
      await pushSlide({ type: 'image', url });
      toast('Uploaded & showing on screen!');
      fileInput.value = '';
      document.getElementById('uploadPreviewWrap').style.display = 'none';
      loadImages();
    } catch (err) {
      document.getElementById('uploadErr').textContent = 'Upload failed: ' + err.message;
      toast('Upload failed.', false);
    } finally {
      btn.disabled = false; btn.textContent = 'Upload & Show';
    }
  }

  // â”€â”€ Saved images grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadImages() {
    const grid = document.getElementById('imageGrid');
    grid.innerHTML = '<span class="spinner"></span>';
    const { data: files, error } = await sb.storage.from('announcements').list('', {
      limit: 50, sortBy: { column: 'created_at', order: 'desc' }
    });
    if (error || !files?.length) {
      grid.innerHTML = '<div style="color:var(--muted); font-size:0.85rem;">No images yet.</div>';
      return;
    }
    grid.innerHTML = files.filter(f => f.name !== '.emptyFolderPlaceholder').map(f => {
      const url = sb.storage.from('announcements').getPublicUrl(f.name).data.publicUrl;
      return `<div style="cursor:pointer; border-radius:8px; overflow:hidden; border:2px solid var(--border); aspect-ratio:1;"
                   onclick="pushSlide({type:'image',url:'${url.replace(/'/g,"\\'")}'})">
                <img src="${url}" loading="lazy"
                     style="width:100%; height:100%; object-fit:cover;"
                     title="Click to show on screen" />
              </div>`;
    }).join('');
  }

  loadImages();
</script>
</body>
</html>
