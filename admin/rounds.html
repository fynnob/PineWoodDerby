<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Round Control â€” Pinewood Derby</title>
  <link rel="stylesheet" href="../styles.css" />
</head>
<body>

<nav class="top-nav">
  <span class="brand">ğŸï¸ Derby</span>
  <a href="index.html">Hub</a>
  <a href="inspection.html">Inspection</a>
  <a href="track.html">Track</a>
  <a href="results.html">Results</a>
  <a href="rounds.html" class="active">Rounds</a>
</nav>

<div class="container">

  <!-- Current round state -->
  <div class="card" id="currentRoundCard">
    <div class="card-title">Current Round</div>
    <div id="currentRoundBody"><span class="spinner"></span></div>
  </div>

  <!-- Start / advance round -->
  <div class="card" id="actionCard">
    <div class="card-title">Actions</div>
    <div id="actionBody"><span class="spinner"></span></div>
  </div>

  <!-- Round standings -->
  <div class="card" id="standingsCard">
    <div class="card-title">Current Round Standings</div>
    <div id="standingsBody"><span class="spinner"></span></div>
  </div>

  <!-- All rounds history -->
  <div class="card">
    <div class="card-title">All Rounds</div>
    <div id="allRoundsBody"><span class="spinner"></span></div>
  </div>

</div>

<div id="toast"></div>

<script src="../config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script>
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  function toast(msg, ok = true) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.style.borderColor = ok ? 'var(--success)' : 'var(--danger)';
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 3000);
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Heat Generation
  // Algorithm: for N eligible cars, generate N heats.
  // Heat h (0-indexed): lane k (1-indexed) gets car[(h + k-1) % N]
  // This guarantees each car races exactly once in each lane position.
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function generateHeatSchedule(carIds) {
    const n     = carIds.length;
    const heats = [];
    for (let h = 0; h < n; h++) {
      const entries = [];
      for (let lane = 1; lane <= 4; lane++) {
        entries.push({ lane, carId: carIds[(h + lane - 1) % n] });
      }
      heats.push(entries);
    }
    return heats;
  }

  // â”€â”€ Load page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadPage() {
    const [{ data: state }, { data: allRounds }] = await Promise.all([
      sb.from('race_state').select('current_round_id, current_heat_id').eq('id', 1).single(),
      sb.from('rounds').select('*').order('round_number')
    ]);

    renderAllRounds(allRounds || []);

    const roundId = state?.current_round_id;

    if (!roundId) {
      // No round started yet
      document.getElementById('currentRoundBody').innerHTML =
        '<p>No round started yet.</p>';
      document.getElementById('actionBody').innerHTML = `
        <p style="margin-bottom:16px;">
          Start Round 1 to begin racing. Only <strong>legal</strong> cars will be included.
        </p>
        <button class="btn btn-gold btn-lg" onclick="startFirstRound()">
          ğŸš¦ Start Round 1
        </button>`;
      document.getElementById('standingsBody').innerHTML =
        '<div class="empty-state">No active round.</div>';
      return;
    }

    // Load current round detail
    const { data: round } = await sb
      .from('rounds')
      .select('*')
      .eq('id', roundId)
      .single();

    const { data: heats } = await sb
      .from('heats')
      .select('id, heat_number, status')
      .eq('round_id', roundId)
      .order('heat_number');

    const totalHeats     = heats?.length ?? 0;
    const completedHeats = heats?.filter(h => h.status === 'completed').length ?? 0;
    const allDone        = totalHeats > 0 && completedHeats === totalHeats;

    document.getElementById('currentRoundBody').innerHTML = `
      <div style="display:flex; gap:24px; flex-wrap:wrap; align-items:center;">
        <div>
          <div style="font-size:0.75rem;color:var(--muted);text-transform:uppercase;">Round</div>
          <div style="font-size:2rem;font-weight:900;color:var(--accent)">#${round.round_number}</div>
        </div>
        <div>
          <div style="font-size:0.75rem;color:var(--muted);text-transform:uppercase;">Status</div>
          <div style="margin-top:4px;"><span class="badge badge-${round.status}">${round.status}</span></div>
        </div>
        <div>
          <div style="font-size:0.75rem;color:var(--muted);text-transform:uppercase;">Heats</div>
          <div style="font-size:1.5rem;font-weight:800;">${completedHeats} / ${totalHeats} done</div>
        </div>
      </div>
    `;

    renderStandings(roundId);

    // Actions
    if (allDone && round.status === 'active') {
      document.getElementById('actionBody').innerHTML = `
        <p style="margin-bottom:16px; color:var(--success); font-weight:600;">
          ğŸ‰ All ${totalHeats} heats complete!
        </p>
        <p style="margin-bottom:16px;">
          How many cars advance to Round ${round.round_number + 1}?
        </p>
        <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:20px;">
          <input type="number" id="advanceCount" min="2" max="99"
                 placeholder="e.g. 8" style="width:120px; margin:0;" />
          <button class="btn btn-primary" onclick="closeRoundAndAdvance('${roundId}', ${round.round_number})">
            Confirm &amp; Start Next Round
          </button>
        </div>
        <p style="font-size:0.8rem; color:var(--muted);">
          Cars are ranked by total position points (lowest = best).
          The bottom cars will be eliminated.
        </p>
      `;
    } else if (round.status === 'active') {
      document.getElementById('actionBody').innerHTML = `
        <p>Round is live â€” ${completedHeats}/${totalHeats} heats done.</p>
        <p style="margin-top:8px; font-size:0.85rem; color:var(--muted);">
          Advance heats from the <a href="track.html" style="color:var(--accent2);">Track page</a>
          and enter results from <a href="results.html" style="color:var(--accent2);">Results page</a>.
        </p>
      `;
    } else {
      document.getElementById('actionBody').innerHTML =
        `<p>Round ${round.round_number} status: <strong>${round.status}</strong></p>`;
    }
  }

  // â”€â”€ Standings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function renderStandings(roundId) {
    // Compute standings by fetching all heat results for this round
    const { data: results } = await sb
      .from('heat_results')
      .select(`
        first_place_car, second_place_car, third_place_car, fourth_place_car,
        heats!inner(round_id)
      `)
      .eq('heats.round_id', roundId);

    const { data: activeCars } = await sb
      .from('cars')
      .select('id, car_number, kid_name')
      .eq('eliminated', false);

    if (!activeCars?.length) {
      document.getElementById('standingsBody').innerHTML =
        '<div class="empty-state">No active cars.</div>';
      return;
    }

    // Tally points
    const pts = {};
    activeCars.forEach(c => pts[c.id] = 0);

    (results || []).forEach(r => {
      if (pts[r.first_place_car]  !== undefined) pts[r.first_place_car]  += 1;
      if (pts[r.second_place_car] !== undefined) pts[r.second_place_car] += 2;
      if (pts[r.third_place_car]  !== undefined) pts[r.third_place_car]  += 3;
      if (pts[r.fourth_place_car] !== undefined) pts[r.fourth_place_car] += 4;
    });

    const sorted = activeCars
      .map(c => ({ ...c, points: pts[c.id] ?? 0 }))
      .sort((a, b) => a.points - b.points || a.car_number - b.car_number);

    document.getElementById('standingsBody').innerHTML = sorted.map((car, i) => `
      <div class="leaderboard-row ${i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : ''}">
        <div class="rank">${i + 1}</div>
        <div class="car-num">#${car.car_number}</div>
        <div class="name">${car.kid_name}</div>
        <div class="pts">${car.points} pts</div>
      </div>
    `).join('');
  }

  // â”€â”€ Start first round â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function startFirstRound() {
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Generatingâ€¦';

    try {
      // Get all legal, non-eliminated cars
      const { data: cars } = await sb
        .from('cars')
        .select('id, car_number, kid_name')
        .eq('legal_status', 'legal')
        .eq('eliminated', false)
        .order('car_number');

      if (!cars?.length) {
        toast('No legal cars found! Approve cars in Inspection first.', false);
        return;
      }
      if (cars.length < 4) {
        toast(`Need at least 4 legal cars. Currently have ${cars.length}.`, false);
        return;
      }

      await startRound(cars, 1);
    } finally {
      btn.disabled = false;
      btn.innerHTML = 'ğŸš¦ Start Round 1';
      loadPage();
    }
  }

  // â”€â”€ Close round + start next â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function closeRoundAndAdvance(roundId, currentRoundNumber) {
    const advCount = parseInt(document.getElementById('advanceCount').value);
    if (!advCount || advCount < 2) {
      toast('Enter a valid advance count (â‰¥ 2).', false);
      return;
    }

    // Get current standings
    const { data: results } = await sb
      .from('heat_results')
      .select(`
        first_place_car, second_place_car, third_place_car, fourth_place_car,
        heats!inner(round_id)
      `)
      .eq('heats.round_id', roundId);

    const { data: activeCars } = await sb
      .from('cars')
      .select('id, car_number, kid_name')
      .eq('eliminated', false);

    const pts = {};
    activeCars.forEach(c => pts[c.id] = 0);
    (results || []).forEach(r => {
      if (pts[r.first_place_car]  !== undefined) pts[r.first_place_car]  += 1;
      if (pts[r.second_place_car] !== undefined) pts[r.second_place_car] += 2;
      if (pts[r.third_place_car]  !== undefined) pts[r.third_place_car]  += 3;
      if (pts[r.fourth_place_car] !== undefined) pts[r.fourth_place_car] += 4;
    });

    const sorted = activeCars
      .map(c => ({ ...c, points: pts[c.id] ?? 0 }))
      .sort((a, b) => a.points - b.points || a.car_number - b.car_number);

    const advancing   = sorted.slice(0, advCount);
    const eliminated  = sorted.slice(advCount);

    const confirmMsg = [
      `Advancing: ${advancing.map(c => '#' + c.car_number + ' ' + c.kid_name).join(', ')}`,
      '',
      `Eliminated: ${eliminated.length ? eliminated.map(c => '#' + c.car_number + ' ' + c.kid_name).join(', ') : 'None'}`,
    ].join('\n');

    if (!confirm(confirmMsg + '\n\nConfirm?')) return;

    const btn = document.querySelector('button[onclick^="closeRoundAndAdvance"]');
    if (btn) { btn.disabled = true; btn.textContent = 'Workingâ€¦'; }

    try {
      // Mark eliminated cars
      if (eliminated.length) {
        await sb
          .from('cars')
          .update({ eliminated: true })
          .in('id', eliminated.map(c => c.id));
      }

      // Mark current round completed, save advance_count
      await sb
        .from('rounds')
        .update({ status: 'completed', advance_count: advCount })
        .eq('id', roundId);

      // Start new round with advancing cars
      await startRound(advancing, currentRoundNumber + 1);

      toast(`Round ${currentRoundNumber + 1} started with ${advancing.length} cars!`);
    } finally {
      loadPage();
    }
  }

  // â”€â”€ Core: create round, heats, entries, set race_state â”€â”€â”€â”€â”€â”€â”€â”€
  async function startRound(cars, roundNumber) {
    // Create round record
    const { data: round, error: rErr } = await sb
      .from('rounds')
      .insert({ round_number: roundNumber, status: 'active' })
      .select()
      .single();

    if (rErr) throw rErr;

    // Generate heat schedule
    const schedule = generateHeatSchedule(cars.map(c => c.id));

    // Insert all heats at once
    const heatInserts = schedule.map((_, i) => ({
      round_id: round.id,
      heat_number: i + 1,
      status: 'pending'
    }));

    const { data: insertedHeats, error: hErr } = await sb
      .from('heats')
      .insert(heatInserts)
      .select('id, heat_number')
      .order('heat_number');

    if (hErr) throw hErr;

    // Insert all heat entries
    const entryInserts = [];
    insertedHeats.forEach((heat, hIdx) => {
      schedule[hIdx].forEach(({ lane, carId }) => {
        entryInserts.push({ heat_id: heat.id, lane_number: lane, car_id: carId });
      });
    });

    const { error: eErr } = await sb.from('heat_entries').insert(entryInserts);
    if (eErr) throw eErr;

    // Activate first heat
    const firstHeat = insertedHeats[0];
    await sb.from('heats').update({ status: 'active' }).eq('id', firstHeat.id);

    // Set race state
    await sb.from('race_state').update({
      current_round_id: round.id,
      current_heat_id:  firstHeat.id,
      updated_at:       new Date().toISOString()
    }).eq('id', 1);
  }

  // â”€â”€ All rounds history â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderAllRounds(rounds) {
    if (!rounds.length) {
      document.getElementById('allRoundsBody').innerHTML =
        '<div class="empty-state">No rounds yet.</div>';
      return;
    }

    document.getElementById('allRoundsBody').innerHTML = rounds.map(r => `
      <div class="leaderboard-row">
        <div class="rank">#${r.round_number}</div>
        <div class="name">Round ${r.round_number}</div>
        <span class="badge badge-${r.status}">${r.status}</span>
        ${r.advance_count ? `<span style="font-size:0.8rem;color:var(--muted);">Top ${r.advance_count} advanced</span>` : ''}
      </div>
    `).join('');
  }

  // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  loadPage();
</script>
</body>
</html>
