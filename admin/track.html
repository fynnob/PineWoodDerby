<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Track â€” Pinewood Derby</title>
  <link rel="stylesheet" href="../styles.css" />
</head>
<body>

<nav class="top-nav">
  <span class="brand">ğŸï¸ Derby</span>
  <a href="index.html">Hub</a>
  <a href="inspection.html">Inspection</a>
  <a href="track.html" class="active">Track</a>
  <a href="results.html">Officials</a>
  <a href="cars.html">Cars</a>
</nav>

<div class="container">

  <!-- Heat browsing navigation -->
  <div class="heat-nav">
    <button class="btn btn-ghost" id="prevBtn" onclick="browse(-1)" style="min-width:56px;">â—€</button>
    <div class="heat-nav-label" id="heatNavLabel">Loadingâ€¦</div>
    <button class="btn btn-ghost" id="nextBtn" onclick="browse(1)"  style="min-width:56px;">â–¶</button>
  </div>

  <!-- Lane board -->
  <div class="lane-board" id="laneBoard">
    <div class="lane-card"><div class="lane-label">Lane 1</div><div class="car-number">â€”</div></div>
    <div class="lane-card"><div class="lane-label">Lane 2</div><div class="car-number">â€”</div></div>
    <div class="lane-card"><div class="lane-label">Lane 3</div><div class="car-number">â€”</div></div>
    <div class="lane-card"><div class="lane-label">Lane 4</div><div class="car-number">â€”</div></div>
  </div>

</div>

<script src="../config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script>
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let allHeats   = [];  // [{id, heat_number, round_number}]
  let viewIndex  = 0;   // index into allHeats we're currently viewing

  // â”€â”€ Load all heats for current round â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function init() {
    const { data: state } = await sb
      .from('race_state')
      .select('current_round_id, current_heat_id')
      .eq('id', 1)
      .single();

    if (!state?.current_round_id) {
      document.getElementById('heatNavLabel').textContent = 'No active round';
      renderEmptyBoard();
      return;
    }

    const { data: heats } = await sb
      .from('heats')
      .select('id, heat_number, rounds(round_number)')
      .eq('round_id', state.current_round_id)
      .order('heat_number');

    if (!heats?.length) {
      document.getElementById('heatNavLabel').textContent = 'No heats yet';
      renderEmptyBoard();
      return;
    }

    allHeats = heats.map(h => ({
      id:           h.id,
      heat_number:  h.heat_number,
      round_number: h.rounds?.round_number ?? '?'
    }));

    // Default to current heat
    const currentIdx = allHeats.findIndex(h => h.id === state.current_heat_id);
    viewIndex = currentIdx >= 0 ? currentIdx : 0;

    showHeat(viewIndex);
  }

  function browse(delta) {
    const next = viewIndex + delta;
    if (next < 0 || next >= allHeats.length) return;
    viewIndex = next;
    showHeat(viewIndex);
  }

  async function showHeat(idx) {
    const h = allHeats[idx];

    document.getElementById('heatNavLabel').textContent =
      `Round ${h.round_number} â€” Heat ${h.heat_number} (${idx + 1}/${allHeats.length})`;
    document.getElementById('prevBtn').disabled = idx === 0;
    document.getElementById('nextBtn').disabled = idx === allHeats.length - 1;

    const { data: entries } = await sb
      .from('heat_entries')
      .select('lane_number, cars(car_number, kid_name)')
      .eq('heat_id', h.id)
      .order('lane_number');

    const lanes = {};
    (entries || []).forEach(e => lanes[e.lane_number] = e.cars);

    document.getElementById('laneBoard').innerHTML = [1, 2, 3, 4].map(l => {
      const car = lanes[l];
      return `
        <div class="lane-card">
          <div class="lane-label">Lane ${l}</div>
          <div class="car-number">${car ? car.car_number : 'â€”'}</div>
          <div class="kid-name">${car ? car.kid_name : ''}</div>
        </div>`;
    }).join('');
  }

  function renderEmptyBoard() {
    document.getElementById('laneBoard').innerHTML = [1,2,3,4].map(l => `
      <div class="lane-card">
        <div class="lane-label">Lane ${l}</div>
        <div class="car-number">â€”</div>
      </div>`).join('');
  }

  // Auto-refresh: if we're viewing the current heat, keep it live
  setInterval(async () => {
    if (!allHeats.length) { init(); return; }
    const { data: state } = await sb
      .from('race_state').select('current_heat_id').eq('id', 1).single();
    const currentIdx = allHeats.findIndex(h => h.id === state?.current_heat_id);
    // Only auto-jump if user is on current heat
    if (currentIdx >= 0 && viewIndex === currentIdx) showHeat(currentIdx);
  }, 10000);

  init();
</script>
</body>
