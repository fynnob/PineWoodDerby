<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Track â€” Pinewood Derby</title>
  <link rel="stylesheet" href="../styles.css" />
</head>
<body>

<!-- PIN gate -->
<div id="pinGate" style="position:fixed;inset:0;z-index:9999;background:var(--bg);display:flex;align-items:center;justify-content:center;">
  <div style="text-align:center;max-width:300px;padding:20px;">
    <h2 style="margin-bottom:8px;">Admin Access</h2>
    <p style="margin-bottom:16px;">Enter the 4-digit PIN</p>
    <input type="tel" id="pinInput" maxlength="4" placeholder="â€¢â€¢â€¢â€¢" autocomplete="off"
           style="text-align:center;font-size:2rem;letter-spacing:12px;width:160px;margin:0 auto 16px;display:block;" />
    <p id="pinErr" style="color:var(--danger);font-size:0.82rem;min-height:1.4em;"></p>
  </div>
</div>
<script>
(function(){
  const PIN='2468',KEY='derby_admin_pin';
  if(localStorage.getItem(KEY)===PIN){document.getElementById('pinGate').style.display='none';}
  else{document.getElementById('pinInput').addEventListener('input',function(){if(this.value.length===4){if(this.value===PIN){localStorage.setItem(KEY,PIN);document.getElementById('pinGate').style.display='none';}else{document.getElementById('pinErr').textContent='Wrong PIN';this.value='';}}});document.getElementById('pinInput').focus();}
})();
</script>

<nav class="top-nav">
  <span class="brand">Derby</span>
  <a href="index.html">Hub</a>
  <a href="inspection.html">Inspection</a>
  <a href="track.html" class="active">Track</a>
  <a href="results.html">Officials</a>
  <a href="cars.html">Cars</a>
  <a href="editor.html">Editor</a>
</nav>

<div class="container">

  <!-- Heat browsing navigation -->
  <div class="heat-nav">
    <button class="btn btn-ghost" id="prevBtn" onclick="browse(-1)" style="min-width:56px;">â—€</button>
    <div class="heat-nav-label" id="heatNavLabel">Loadingâ€¦</div>
    <button class="btn btn-ghost" id="nextBtn" onclick="browse(1)"  style="min-width:56px;">â–¶</button>
  </div>

  <!-- Lane board -->
  <div class="lane-board" id="laneBoard">
    <div class="lane-card"><div class="lane-label">Lane 1</div><div class="car-number">â€”</div></div>
    <div class="lane-card"><div class="lane-label">Lane 2</div><div class="car-number">â€”</div></div>
    <div class="lane-card"><div class="lane-label">Lane 3</div><div class="car-number">â€”</div></div>
    <div class="lane-card"><div class="lane-label">Lane 4</div><div class="car-number">â€”</div></div>
  </div>

  <!-- Re-race button -->
  <div style="margin-top:20px;">
    <button class="btn btn-lg btn-full" onclick="broadcastRerace()"
            style="border-color:var(--danger); color:var(--danger); background:transparent;">
      ðŸ”„ Re-race This Heat
    </button>
  </div>

</div>

<div id="toast"></div>

<script src="../config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script>
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let allHeats      = [];  // [{id, heat_number, round_number, status}]
  let viewIndex    = 0;    // index into allHeats we're currently viewing
  let currentHeatId = null;

  // â”€â”€ Load all heats for current round â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function init() {
    const { data: state } = await sb
      .from('race_state')
      .select('current_round_id, current_heat_id')
      .eq('id', 1)
      .single();

    if (!state?.current_round_id) {
      document.getElementById('heatNavLabel').textContent = 'No active round';
      renderEmptyBoard();
      return;
    }

    currentHeatId = state.current_heat_id;

    const { data: heats } = await sb
      .from('heats')
      .select('id, heat_number, status, rounds(round_number)')
      .eq('round_id', state.current_round_id)
      .order('heat_number');

    if (!heats?.length) {
      document.getElementById('heatNavLabel').textContent = 'No heats yet';
      renderEmptyBoard();
      return;
    }

    allHeats = heats.map(h => ({
      id:           h.id,
      heat_number:  h.heat_number,
      round_number: h.rounds?.round_number ?? '?',
      status:       h.status
    }));

    // Default to current heat
    const currentIdx = allHeats.findIndex(h => h.id === state.current_heat_id);
    viewIndex = currentIdx >= 0 ? currentIdx : 0;

    showHeat(viewIndex);
  }

  function browse(delta) {
    const next = viewIndex + delta;
    if (next < 0 || next >= allHeats.length) return;
    viewIndex = next;
    showHeat(viewIndex);
  }

  async function showHeat(idx) {
    const h = allHeats[idx];

    const heatState = h.id === currentHeatId ? 'current'
                    : h.status === 'completed'  ? 'past'
                    : 'future';

    const label = document.getElementById('heatNavLabel');
    label.textContent = `Round ${h.round_number} â€” Heat ${h.heat_number} (${idx + 1}/${allHeats.length})`;
    label.className = 'heat-nav-label state-' + heatState;

    document.getElementById('laneBoard').className = 'lane-board state-' + heatState;
    document.getElementById('prevBtn').disabled = idx === 0;
    document.getElementById('nextBtn').disabled = idx === allHeats.length - 1;

    const { data: entries } = await sb
      .from('heat_entries')
      .select('lane_number, cars(car_number, kid_name)')
      .eq('heat_id', h.id)
      .order('lane_number');

    const lanes = {};
    (entries || []).forEach(e => lanes[e.lane_number] = e.cars);

    document.getElementById('laneBoard').innerHTML = [1, 2, 3, 4].map(l => {
      const car = lanes[l];
      return `
        <div class="lane-card">
          <div class="lane-label">Lane ${l}</div>
          <div class="car-number">${car ? car.car_number : 'â€”'}</div>
          <div class="kid-name">${car ? car.kid_name : ''}</div>
        </div>`;
    }).join('');
  }

  function renderEmptyBoard() {
    document.getElementById('laneBoard').innerHTML = [1,2,3,4].map(l => `
      <div class="lane-card">
        <div class="lane-label">Lane ${l}</div>
        <div class="car-number">â€”</div>
      </div>`).join('');
  }

  // â”€â”€ Live state sync (no auto-navigate) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Updates currentHeatId + all heat statuses, then re-renders
  // whatever heat the user is currently viewing (viewIndex unchanged).
  async function refreshState() {
    if (!allHeats.length) { await init(); return; }

    // Fetch latest race_state
    const { data: state } = await sb
      .from('race_state')
      .select('current_heat_id')
      .eq('id', 1)
      .single();
    currentHeatId = state?.current_heat_id ?? null;

    // Refresh statuses for all heats we know about
    const { data: heats } = await sb
      .from('heats')
      .select('id, status')
      .in('id', allHeats.map(h => h.id));
    if (heats) {
      heats.forEach(h => {
        const i = allHeats.findIndex(a => a.id === h.id);
        if (i >= 0) allHeats[i].status = h.status;
      });
    }

    // Re-render current view (no viewIndex change)
    showHeat(viewIndex);
  }

  // Realtime: immediate push when heat status or active heat changes
  sb.channel('track-live')
    .on('postgres_changes',
        { event: 'UPDATE', schema: 'public', table: 'heats' },
        payload => {
          const i = allHeats.findIndex(h => h.id === payload.new.id);
          if (i >= 0) { allHeats[i].status = payload.new.status; showHeat(viewIndex); }
        })
    .on('postgres_changes',
        { event: 'UPDATE', schema: 'public', table: 'race_state' },
        payload => {
          if (payload.new.id === 1) { currentHeatId = payload.new.current_heat_id; showHeat(viewIndex); }
        })
    .on('postgres_changes',
        { event: 'INSERT', schema: 'public', table: 'heat_results' },
        () => refreshState())
    .subscribe();

  // Fallback poll every 15 s in case Realtime misses an event
  setInterval(refreshState, 15000);

  // â”€â”€ Re-race broadcast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const announceCh = sb.channel('announcer-control').subscribe();

  function broadcastRerace() {
    announceCh.send({ type: 'broadcast', event: 'announce',
      payload: { type: 're-race', message: 'ðŸ”„ RE-RACE', sub: 'Please reset the track', duration: 0 }
    });
    toast('Re-race signal sent to display!');
  }

  function toast(msg, ok = true) {
    const el = document.getElementById('toast');
    el.textContent = msg; el.className = ok ? 'show ok' : 'show err';
    setTimeout(() => el.className = '', 3000);
  }

  init();
</script>
</body>
