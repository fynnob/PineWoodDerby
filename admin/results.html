<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Results Entry â€” Pinewood Derby</title>
  <link rel="stylesheet" href="../styles.css" />
</head>
<body>

<nav class="top-nav">
  <span class="brand">ğŸï¸ Derby</span>
  <a href="index.html">Hub</a>
  <a href="inspection.html">Inspection</a>
  <a href="track.html">Track</a>
  <a href="results.html" class="active">Results</a>
  <a href="rounds.html">Rounds</a>
</nav>

<div class="container">

  <div class="card" id="heatInfoCard">
    <div style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:12px;">
      <div>
        <div style="font-size:0.75rem; color:var(--muted); text-transform:uppercase;">Entering Results For</div>
        <h2 id="heatLabel" style="color:var(--accent2);">Loadingâ€¦</h2>
      </div>
      <span id="existingBadge" style="display:none;" class="badge badge-completed">Results already entered</span>
    </div>
  </div>

  <div id="noHeatMsg" class="card" style="display:none;">
    <div class="empty-state">
      No active heat. Advance to the next heat from the
      <a href="track.html" style="color:var(--accent2);">Track page</a>.
    </div>
  </div>

  <!-- Finish order picker -->
  <div class="card" id="finishCard" style="display:none;">
    <div class="card-title">Assign Finish Positions</div>

    <!--
      One row per lane â€” the user picks which position (1stâ€“4th) that car finished.
      Validation ensures no two cars share the same position.
    -->
    <div class="finish-grid" id="finishGrid"></div>

    <hr class="divider" />

    <!-- Quick-tap shortcut: tap cars in order 1â†’2â†’3â†’4 -->
    <div class="card-title" style="margin-top:8px;">Quick Tap Order</div>
    <p style="margin-bottom:12px; font-size:0.85rem;">
      Tap cars in finish order. First tap = 1st place, etc.
    </p>
    <div id="quickTap" style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:16px;"></div>
    <button class="btn btn-ghost btn-sm" onclick="resetQuickTap()">Reset Quick Tap</button>

    <hr class="divider" />

    <button class="btn btn-gold btn-lg btn-full" id="submitBtn" onclick="submitResults()">
      Submit Results
    </button>
  </div>

  <!-- Existing result display -->
  <div class="card" id="existingCard" style="display:none;">
    <div class="card-title">Results (Already Entered)</div>
    <div id="existingBody"></div>
    <hr class="divider" />
    <button class="btn btn-danger" onclick="clearResults()">âš  Clear &amp; Re-enter</button>
  </div>

</div>

<div id="toast"></div>

<script src="../config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script>
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  let currentHeatId   = null;
  let heatEntries     = [];   // [{lane_number, car_id, car_number, kid_name}]
  let quickTapOrder   = [];   // car_ids in tap order

  function toast(msg, ok = true) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.style.borderColor = ok ? 'var(--success)' : 'var(--danger)';
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 3000);
  }

  // â”€â”€ Load active heat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadHeat() {
    const { data: state } = await sb
      .from('race_state')
      .select('current_heat_id, current_round_id, heats(heat_number, status, rounds(round_number))')
      .eq('id', 1)
      .single();

    if (!state?.current_heat_id) {
      document.getElementById('noHeatMsg').style.display   = 'block';
      document.getElementById('finishCard').style.display  = 'none';
      document.getElementById('heatInfoCard').style.display = 'none';
      return;
    }

    currentHeatId = state.current_heat_id;
    const heat    = state.heats;
    const round   = heat?.rounds;

    document.getElementById('heatLabel').textContent =
      `Round ${round?.round_number ?? '?'} â€” Heat ${heat?.heat_number ?? '?'}`;

    // Fetch lane entries
    const { data: entries } = await sb
      .from('heat_entries')
      .select('lane_number, car_id, cars(car_number, kid_name)')
      .eq('heat_id', currentHeatId)
      .order('lane_number');

    heatEntries = (entries || []).map(e => ({
      lane_number: e.lane_number,
      car_id:      e.car_id,
      car_number:  e.cars.car_number,
      kid_name:    e.cars.kid_name
    }));

    // Check for existing results
    const { data: existing } = await sb
      .from('heat_results')
      .select('*')
      .eq('heat_id', currentHeatId)
      .maybeSingle();

    if (existing) {
      showExistingResults(existing);
    } else {
      document.getElementById('finishCard').style.display   = 'block';
      document.getElementById('existingCard').style.display = 'none';
      document.getElementById('existingBadge').style.display = 'none';
      renderFinishGrid();
      renderQuickTap();
    }
  }

  // â”€â”€ Finish grid (dropdowns) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderFinishGrid() {
    const positions = ['1st Place', '2nd Place', '3rd Place', '4th Place'];
    document.getElementById('finishGrid').innerHTML = heatEntries.map(e => `
      <div class="finish-lane">
        <div class="lane-heading">Lane ${e.lane_number}</div>
        <div class="car-badge">#${e.car_number}</div>
        <div style="font-size:0.85rem; color:var(--muted); margin:4px 0 8px;">${e.kid_name}</div>
        <select id="pos_${e.car_id}" onchange="syncQuickTap()">
          <option value="">Select finishâ€¦</option>
          ${positions.map((p, i) => `<option value="${i+1}">${p}</option>`).join('')}
        </select>
      </div>
    `).join('');
  }

  // â”€â”€ Quick-tap â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderQuickTap() {
    quickTapOrder = [];
    document.getElementById('quickTap').innerHTML = heatEntries.map(e => `
      <button class="btn btn-ghost btn-lg" id="tap_${e.car_id}"
              onclick="tapCar('${e.car_id}')">
        #${e.car_number}<br/>
        <span style="font-size:0.75rem; color:var(--muted);">${e.kid_name}</span>
      </button>
    `).join('');
  }

  function tapCar(carId) {
    if (quickTapOrder.includes(carId)) return;
    quickTapOrder.push(carId);

    const pos = quickTapOrder.length;
    const btn = document.getElementById('tap_' + carId);
    const gold = '#f5c518'; const colors = [gold, '#c0c0c0', '#cd7f32', 'var(--accent2)'];
    btn.style.borderColor = colors[pos - 1] || 'var(--accent2)';
    btn.style.color = colors[pos - 1] || 'var(--text)';

    // Sync to dropdown
    const sel = document.getElementById('pos_' + carId);
    if (sel) { sel.value = pos; }

    if (quickTapOrder.length === heatEntries.length) {
      toast('All positions set! Hit Submit.');
    }
  }

  function resetQuickTap() {
    quickTapOrder = [];
    renderFinishGrid();
    renderQuickTap();
  }

  function syncQuickTap() {
    // When dropdowns are manually changed, re-sync quick tap visual
    quickTapOrder = [];
    heatEntries.forEach(e => {
      const sel = document.getElementById('pos_' + e.car_id);
      if (sel?.value) quickTapOrder[parseInt(sel.value) - 1] = e.car_id;
    });
    quickTapOrder = quickTapOrder.filter(Boolean);
  }

  // â”€â”€ Submit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function submitResults() {
    // Read positions from dropdowns
    const posMap = {}; // position -> car_id
    for (const e of heatEntries) {
      const sel = document.getElementById('pos_' + e.car_id);
      const val = sel ? parseInt(sel.value) : 0;
      if (!val) {
        toast(`Set a position for every car first.`, false);
        return;
      }
      if (posMap[val]) {
        toast(`Two cars can't share the same position!`, false);
        return;
      }
      posMap[val] = e.car_id;
    }

    // We need all 4 positions filled
    for (let p = 1; p <= heatEntries.length; p++) {
      if (!posMap[p]) {
        toast(`Position ${p} is not assigned.`, false);
        return;
      }
    }

    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Savingâ€¦';

    try {
      const { error } = await sb.from('heat_results').insert({
        heat_id:          currentHeatId,
        first_place_car:  posMap[1],
        second_place_car: posMap[2],
        third_place_car:  posMap[3],
        fourth_place_car: posMap[4]
      });

      if (error) throw error;

      toast('Results saved! ğŸ');

      // Reload to show existing view
      setTimeout(loadHeat, 800);
    } catch (err) {
      toast('Save failed: ' + err.message, false);
    } finally {
      btn.disabled = false;
      btn.innerHTML = 'Submit Results';
    }
  }

  // â”€â”€ Show existing results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showExistingResults(result) {
    document.getElementById('finishCard').style.display   = 'none';
    document.getElementById('existingCard').style.display = 'block';
    document.getElementById('existingBadge').style.display = 'inline-block';

    const places = [
      { label: 'ğŸ¥‡ 1st', id: result.first_place_car },
      { label: 'ğŸ¥ˆ 2nd', id: result.second_place_car },
      { label: 'ğŸ¥‰ 3rd', id: result.third_place_car },
      { label: '4th',    id: result.fourth_place_car },
    ];

    const carMap = {};
    heatEntries.forEach(e => carMap[e.car_id] = e);

    document.getElementById('existingBody').innerHTML = places.map(p => {
      const car = carMap[p.id];
      return `
        <div class="leaderboard-row">
          <div class="rank">${p.label}</div>
          <div class="car-num">#${car?.car_number ?? '?'}</div>
          <div class="name">${car?.kid_name ?? 'Unknown'}</div>
        </div>`;
    }).join('');
  }

  async function clearResults() {
    if (!confirm('Clear the results for this heat and re-enter?')) return;

    const { error } = await sb
      .from('heat_results')
      .delete()
      .eq('heat_id', currentHeatId);

    if (error) { toast('Failed: ' + error.message, false); return; }

    toast('Cleared. Re-enter below.');
    loadHeat();
  }

  // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  loadHeat();
</script>
</body>
</html>
